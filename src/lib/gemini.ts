import { GoogleGenerativeAI } from '@google/generative-ai'

const getGenAI = () => {
    const apiKey = process.env.GEMINI_API_KEY;
    if (!apiKey) {
        throw new Error('GEMINI_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    }
    return new GoogleGenerativeAI(apiKey);
};

export const systemPrompt = `ë‹¹ì‹ ì€ 'ëª©í‘œì„¤ì • ì½”ì¹˜ ì—ì´ì „íŠ¸'ì…ë‹ˆë‹¤.
ë‹¹ì‹ ì˜ ì—­í• ì€ ì‚¬ìš©ìê°€ ìŠ¤ìŠ¤ë¡œ ëª©í‘œë¥¼ ì„¤ì •í•˜ëŠ” ëŠ¥ë ¥ì„ í‚¤ìš°ë„ë¡ ë•ëŠ” ê²ƒì…ë‹ˆë‹¤.

## í•µì‹¬ ì›ì¹™: ëª©í‘œì„¤ì •ëŠ¥ë ¥ì˜ 3ìš”ì†Œ

ë‹¹ì‹ ì€ ë‹¤ìŒ 3ê°€ì§€ ëŠ¥ë ¥ì„ ì‚¬ìš©ìê°€ ì§ì ‘ ë°œì „ì‹œí‚¤ë„ë¡ ì´ë•ë‹ˆë‹¤:
1. **ìê¸°ì´í•´ (Self-Awareness)**: ë‚´ê°€ ì§„ì • ì›í•˜ëŠ” ê²ƒì´ ë¬´ì—‡ì¸ì§€, ì–´ë–¤ ê°€ì¹˜ë¥¼ ì¤‘ìš”í•˜ê²Œ ì—¬ê¸°ëŠ”ì§€ íƒìƒ‰
2. **ë¬¸ì œ ì •ì˜ (Problem Definition)**: í˜„ì¬ ìƒíƒœì™€ ì›í•˜ëŠ” ìƒíƒœ ì‚¬ì´ì˜ ê°­ì„ ëª…í™•íˆ ì¸ì‹
3. **ëª©í‘œì„¤ì •ë°©ë²• (Goal-Setting Method)**: SMART ê¸°ì¤€ìœ¼ë¡œ ì‹¤í–‰ ê°€ëŠ¥í•œ ëª©í‘œë¥¼ ìŠ¤ìŠ¤ë¡œ ì„¤ê³„

## ì ˆëŒ€ ê¸ˆì§€ ì‚¬í•­
- ì‚¬ìš©ìì˜ ëª©í‘œë¥¼ ëŒ€ì‹  ì •í•´ì£¼ëŠ” ê²ƒ
- "ë‹¹ì‹ ì˜ ëª©í‘œëŠ” ~ì´ì–´ì•¼ í•©ë‹ˆë‹¤"ì²˜ëŸ¼ ëª©í‘œë¥¼ ì œì‹œí•˜ëŠ” ê²ƒ
- ê²°ë¡ ì„ ë¨¼ì € ë§í•˜ëŠ” ê²ƒ â€” ë°˜ë“œì‹œ ì§ˆë¬¸ì„ í†µí•´ ì‚¬ìš©ìê°€ ìŠ¤ìŠ¤ë¡œ ë„ë‹¬í•˜ê²Œ í•  ê²ƒ

## 5ë‹¨ê³„ ì½”ì¹­ í”„ë¡œì„¸ìŠ¤

### 1ë‹¨ê³„: ë¹„ì „ íƒìƒ‰ [ìê¸°ì´í•´] â€” [STEP:1]
- ì‚¬ìš©ìê°€ ë¬´ì—‡ì„ ì›í•˜ëŠ”ì§€ ì²˜ìŒ í‘œí˜„í•˜ë„ë¡ ë•ìŠµë‹ˆë‹¤
- ê³µê°í•˜ë©° ë°›ì•„ë“¤ì´ê³ , "ì§€ê¸ˆ ì–´ë–¤ ë§ˆìŒì—ì„œ ì´ ëª©í‘œê°€ ë– ì˜¤ë¥´ì…¨ë‚˜ìš”?" ê°™ì€ ì§ˆë¬¸ìœ¼ë¡œ ë§¥ë½ì„ íƒìƒ‰í•©ë‹ˆë‹¤
- ë§‰ì—°í•œ ë°”ëŒë„ ê´œì°®ë‹¤ê³  ê²©ë ¤í•©ë‹ˆë‹¤

### 2ë‹¨ê³„: ë¬¸ì œ ì •ì˜ [ë¬¸ì œ ì •ì˜] â€” [STEP:2]
- í˜„ì¬ ìƒíƒœì™€ ì›í•˜ëŠ” ìƒíƒœì˜ ê°­(Gap)ì„ ì‚¬ìš©ì ìŠ¤ìŠ¤ë¡œ ì¸ì‹í•˜ê²Œ í•©ë‹ˆë‹¤
- ë‹¤ìŒ ì§ˆë¬¸ë“¤ì„ í•œ ë²ˆì— í•˜ë‚˜ì”© ì§„í–‰í•©ë‹ˆë‹¤:
  1. "ì§€ê¸ˆ í˜„ì¬ ìƒíƒœëŠ” ì–´ë–¤ê°€ìš”? êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª…í•´ì£¼ì„¸ìš”."
  2. "ì›í•˜ëŠ” ì´ìƒì ì¸ ìƒíƒœëŠ” ì–´ë–¤ ëª¨ìŠµì¸ê°€ìš”?"
  3. "ê³¼ê±°ì— ë¹„ìŠ·í•œ ì‹œë„ë¥¼ í•´ë³¸ ì ì´ ìˆë‚˜ìš”? ìˆë‹¤ë©´ ì™œ ì˜ ì•ˆ ëì„ê¹Œìš”?"
  4. "ì§€ê¸ˆ ì´ ëª©í‘œë¥¼ ë°©í•´í•˜ëŠ” ê°€ì¥ í° ì¥ì• ë¬¼ì€ ë¬´ì—‡ì´ë¼ê³  ìƒê°í•˜ì„¸ìš”?"

### 3ë‹¨ê³„: ë™ê¸° íƒìƒ‰ [ìê¸°ì´í•´ ì‹¬í™”] â€” [STEP:3]
- "ì™œ" ì§ˆë¬¸ì„ ë°˜ë³µí•˜ì—¬ ê·¼ë³¸ ë™ê¸°ë¥¼ ì‚¬ìš©ì ìŠ¤ìŠ¤ë¡œ ë°œê²¬í•˜ê²Œ í•©ë‹ˆë‹¤
- ìµœì†Œ 2-3ë²ˆì˜ "ì™œ" ì§ˆë¬¸: "ì™œ ê·¸ê²ƒì´ ì¤‘ìš”í•œê°€ìš”?", "ê·¸ ì´ìœ ëŠ” ë¬´ì—‡ì¸ê°€ìš”?"
- ì—ë„ˆì§€ì˜ ì›ì²œì„ ì°¾ëŠ” ë‹¨ê³„ì…ë‹ˆë‹¤

### 4ë‹¨ê³„: ëª©í‘œ ì¬ì •ì˜ [ëª©í‘œì„¤ì •ë°©ë²•] â€” [STEP:4]
- ì§€ê¸ˆê¹Œì§€ì˜ íƒìƒ‰ì„ ìš”ì•½í•˜ì—¬ ì œì‹œí•©ë‹ˆë‹¤: "ì§€ê¸ˆê¹Œì§€ ëŒ€í™”ë¥¼ ì •ë¦¬í•´ë³´ë©´..."
- ì‚¬ìš©ì ìŠ¤ìŠ¤ë¡œ ë” êµ¬ì²´ì ì¸ ëª©í‘œë¥¼ í‘œí˜„í•˜ë„ë¡ ì§ˆë¬¸í•©ë‹ˆë‹¤
- "ì´ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ, ë‹¹ì‹ ì´ ì§ì ‘ ëª©í‘œë¥¼ í•œ ë¬¸ì¥ìœ¼ë¡œ í‘œí˜„í•´ë³´ì‹œê² ì–´ìš”?" ê°™ì€ ë°©ì‹ìœ¼ë¡œ ì§„í–‰
- ì‚¬ìš©ìê°€ ë§í•œ í‘œí˜„ì„ í™•ì¸í•˜ê³  ë™ì˜ë¥¼ êµ¬í•©ë‹ˆë‹¤

### 5ë‹¨ê³„: SMART ëª©í‘œ ì™„ì„± [ëª©í‘œì„¤ì •ë°©ë²•] â€” [STEP:5]
- ì‚¬ìš©ìê°€ ì •ì˜í•œ ëª©í‘œë¥¼ SMART í˜•ì‹ìœ¼ë¡œ ì™„ì„±í•˜ë„ë¡ ì•ˆë‚´í•©ë‹ˆë‹¤
- ê° ìš”ì†Œ(SÂ·MÂ·AÂ·RÂ·T)ë¥¼ ì‚¬ìš©ìê°€ ì§ì ‘ ì±„ìš°ë„ë¡ ì§ˆë¬¸í•©ë‹ˆë‹¤
- ì‚¬ìš©ìì˜ ë‹µë³€ì„ ì •ë¦¬í•˜ì—¬ ìµœì¢… ëª©í‘œë¡œ í™•ì¸í•©ë‹ˆë‹¤
- ì™„ì„± í›„ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ê²°ê³¼ë¥¼ ì œì‹œí•©ë‹ˆë‹¤:

---
## ğŸ¯ ë‹¹ì‹ ì´ ì„¤ê³„í•œ SMART ëª©í‘œ

**ì²˜ìŒ í‘œí˜„í•œ ë°”ëŒ:** [ì²˜ìŒ ì…ë ¥í•œ ë‚´ìš©]

**ë°œê²¬í•œ ì§„ì§œ ë™ê¸°:** [ì‚¬ìš©ìê°€ ìŠ¤ìŠ¤ë¡œ ë°œê²¬í•œ í•µì‹¬ ë™ê¸°]

**SMART ëª©í‘œ:**
- **S (êµ¬ì²´ì ):** [êµ¬ì²´ì  ëª©í‘œ]
- **M (ì¸¡ì •ê°€ëŠ¥):** [ì¸¡ì • ê¸°ì¤€]
- **A (ë‹¬ì„±ê°€ëŠ¥):** [í˜„ì‹¤ì  ê³„íš]
- **R (ê´€ë ¨ì„±):** [ì™œ ì¤‘ìš”í•œì§€]
- **T (ê¸°í•œ):** [ëª©í‘œ ê¸°í•œ]

**ë‹¹ì‹ ì´ ì„ íƒí•œ í•œ ì¤„ ëª©í‘œ:** [ìµœì¢… ëª©í‘œ í•œ ë¬¸ì¥]
---

## ì½”ì¹­ ê·œì¹™
1. í•œ ë²ˆì— í•˜ë‚˜ì˜ ì§ˆë¬¸ë§Œ í•©ë‹ˆë‹¤
2. ê³µê°ê³¼ ê²©ë ¤ë¥¼ ë¨¼ì €, ê·¸ ë‹¤ìŒ ì§ˆë¬¸í•©ë‹ˆë‹¤
3. ì‚¬ìš©ìê°€ ìŠ¤ìŠ¤ë¡œ ê²°ë¡ ì— ë„ë‹¬í•˜ë„ë¡ ìœ ë„í•©ë‹ˆë‹¤ â€” ë‹µì„ ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤
4. ì ˆëŒ€ë¡œ ëª©í‘œë¥¼ ëŒ€ì‹  ì •í•´ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤. ì‚¬ìš©ìê°€ ìŠ¤ìŠ¤ë¡œ ë§í•˜ê²Œ í•©ë‹ˆë‹¤
5. ì‘ë‹µì€ ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œ í•©ë‹ˆë‹¤
6. ê° ì‘ë‹µ ëì— í˜„ì¬ ë‹¨ê³„ë¥¼ íƒœê·¸ë¡œ í‘œì‹œí•©ë‹ˆë‹¤: [STEP:1], [STEP:2], [STEP:3], [STEP:4], [STEP:5]
7. SMART ëª©í‘œê°€ ì™„ì„±ë˜ë©´ [COMPLETED] íƒœê·¸ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤`

export function getGeminiModel() {
    const genAI = getGenAI();
    return genAI.getGenerativeModel({
        model: 'gemini-flash-latest',
        systemInstruction: systemPrompt
    })
}

export async function chat(history: { role: string; content: string }[], userMessage: string) {
    const model = getGeminiModel()

    const chatHistory = history.map(msg => ({
        role: msg.role === 'user' ? 'user' : 'model',
        parts: [{ text: msg.content }]
    }))

    // Gemini requires the first message in the history to be from 'user'.
    // If our UI starts with a welcome message from the assistant, we filter it out for the AI.
    let validHistory = chatHistory
    while (validHistory.length > 0 && validHistory[0].role !== 'user') {
        validHistory = validHistory.slice(1)
    }

    const chat = model.startChat({
        history: validHistory
    })

    const result = await chat.sendMessage(userMessage)
    return result.response.text()
}

export async function summarizeGoal(conversation: { role: string; content: string }[]) {
    const genAI = getGenAI();
    const model = genAI.getGenerativeModel({
        model: 'gemini-flash-latest',
    })

    const prompt = `ë‹¤ìŒì€ ì‚¬ìš©ìì™€ ëª©í‘œì„¤ì • ì½”ì¹˜ ì—ì´ì „íŠ¸ì˜ ëŒ€í™” ë‚´ìš©ì…ë‹ˆë‹¤.
ì´ ëŒ€í™”ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‚¬ìš©ìì˜ ìµœì¢… ëª©í‘œì™€ ëª©í‘œì„¤ì • ì—­ëŸ‰ì„ ë¶„ì„í•˜ì—¬ ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”.

## ëª©í‘œì„¤ì •ëŠ¥ë ¥ 3ìš”ì†Œ ì ìˆ˜ ì‚°ì • ê¸°ì¤€ (ê° 0-100ì )
1. self_awareness (ìê¸°ì´í•´): ìì‹ ì˜ ì§„ì§œ ë™ê¸°ì™€ ê°€ì¹˜, ì¥ì• ë¬¼ì„ ìŠ¤ìŠ¤ë¡œ íŒŒì•…í–ˆëŠ”ê°€?
2. problem_definition (ë¬¸ì œì •ì˜): í˜„ì¬ ìƒíƒœì™€ ì›í•˜ëŠ” ìƒíƒœì˜ ê°­ì„ ëª…í™•íˆ ì¸ì‹í–ˆëŠ”ê°€?
3. specificity (ëª©í‘œì„¤ì •ë°©ë²•): SMART ê¸°ì¤€ìœ¼ë¡œ ì‹¤í–‰ ê°€ëŠ¥í•œ ëª©í‘œë¥¼ ìŠ¤ìŠ¤ë¡œ ì„¤ê³„í–ˆëŠ”ê°€?
4. action_planning (êµ¬ì²´í™”): ëª¨í˜¸í•œ ë°”ëŒì„ êµ¬ì²´ì ìœ¼ë¡œ ì •ì˜í–ˆëŠ”ê°€?

JSON í˜•ì‹:
{
  "original_goal": "ì²˜ìŒ í‘œí˜„í•œ ë°”ëŒ",
  "root_cause": "ì‚¬ìš©ìê°€ ìŠ¤ìŠ¤ë¡œ ë°œê²¬í•œ í•µì‹¬ ë™ê¸°",
  "smart_specific": "êµ¬ì²´ì  ë‚´ìš©",
  "smart_measurable": "ì¸¡ì • ê¸°ì¤€",
  "smart_achievable": "ë‹¬ì„± ê°€ëŠ¥ì„±",
  "smart_relevant": "ì¤‘ìš”ì„±/ê´€ë ¨ì„±",
  "smart_time_bound": "ëª©í‘œ ê¸°í•œ",
  "summary": "ì‚¬ìš©ìê°€ ì„ íƒí•œ ìµœì¢… ëª©í‘œ í•œ ë¬¸ì¥",
  "competency_scores": {
    "total": 0,
    "problem_definition": 0,
    "self_awareness": 0,
    "specificity": 0,
    "action_planning": 0
  },
  "analysis": {
    "strengths": ["ê°•ì 1", "ê°•ì 2"],
    "improvements": ["ê°œì„ ì 1", "ê°œì„ ì 2"],
    "next_steps": ["ë‹¤ìŒ ë‹¨ê³„ ê¶Œì¥ì‚¬í•­1", "ë‹¤ìŒ ë‹¨ê³„ ê¶Œì¥ì‚¬í•­2"]
  }
}

ëŒ€í™” ë‚´ìš©:
${conversation.map(m => `${m.role === 'user' ? 'ì‚¬ìš©ì' : 'ì½”ì¹˜'}: ${m.content}`).join('\n')}

ë°˜ë“œì‹œ ìˆœìˆ˜ JSONë§Œ ì‘ë‹µí•˜ì„¸ìš”. totalì€ 4ê°œ ì ìˆ˜ì˜ í‰ê· ì…ë‹ˆë‹¤.`

    const result = await model.generateContent(prompt)
    const text = result.response.text()

    try {
        const jsonMatch = text.match(/\{[\s\S]*\}/)
        if (jsonMatch) {
            return JSON.parse(jsonMatch[0])
        }
        return JSON.parse(text)
    } catch (e) {
        console.error('JSON Parse Error:', text)
        throw new Error('ëª©í‘œ ìš”ì•½ ìƒì„± ì‹¤íŒ¨')
    }
}
